<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLS 1.3 Server Handshake Control Flow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <style>
        #mynetwork {
            width: 100%;
            height: 1000px;
            border: 1px solid lightgray;
        }
    </style>
</head>

<body>
    <div id="mynetwork"></div>

    <script>
        // 创建节点
        var nodes = new vis.DataSet([
            { id: 1, label: 'START', level: 0, color: '#FFA07A' },
            { id: 2, label: 'RECVD_CH', level: 1, color: '#98FB98' },
            { id: 3, label: 'NEGOTIATED', level: 2, color: '#87CEFA' },
            { id: 4, label: 'WAIT_EOED', level: 3, color: '#DDA0DD' },
            { id: 5, label: 'WAIT_FLIGHT2', level: 4, color: '#F0E68C' },
            { id: 6, label: 'WAIT_CERT', level: 5, color: '#FFB6C1' },
            { id: 7, label: 'WAIT_CV', level: 6, color: '#20B2AA' },
            { id: 8, label: 'WAIT_FINISHED', level: 7, color: '#FF69B4' },
            { id: 9, label: 'CONNECTED', level: 8, color: '#00CED1' }
        ]);

        // 创建边
        var edges = new vis.DataSet([
            { from: 1, to: 2, label: 'recv_client_hello', arrows: 'to' },
            { from: 2, to: 1, label: 'need_hello_retry_request', arrows: 'to', smooth: { type: 'curvedCW', roundness: 0.4 } },
            { from: 2, to: 3, label: '!need_hello_retry_request', arrows: 'to' },
            { from: 3, to: 4, label: 'using_0rtt', arrows: 'to' },
            { from: 3, to: 5, label: '!using_0rtt', arrows: 'to' },
            { from: 4, to: 5, label: 'recv_end_of_early_data', arrows: 'to' },
            { from: 5, to: 6, label: 'client_auth_required', arrows: 'to' },
            { from: 5, to: 8, label: '!client_auth_required', arrows: 'to', smooth: { type: 'curvedCW', roundness: 0.3 } },
            { from: 6, to: 7, label: 'recv_certificate &&\n!is_empty_certificate', arrows: 'to' },
            { from: 6, to: 8, label: 'recv_certificate &&\nis_empty_certificate', arrows: 'to', smooth: { type: 'curvedCW', roundness: 0.3 } },
            { from: 7, to: 8, label: 'recv_certificate_verify', arrows: 'to' },
            { from: 8, to: 9, label: 'recv_finished', arrows: 'to' }
        ]);

        // 创建网络
        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            layout: {
                hierarchical: {
                    direction: "UD",
                    sortMethod: "directed",
                    levelSeparation: 100,
                    nodeSpacing: 300
                }
            },
            edges: {
                font: {
                    size: 12,
                    align: 'horizontal'
                },
                smooth: {
                    type: 'cubicBezier',
                    forceDirection: 'vertical'
                }
            },
            nodes: {
                shape: 'box',
                font: {
                    bold: true
                },
                margin: 10,
                widthConstraint: {
                    maximum: 150
                }
            },
            physics: false
        };
        var network = new vis.Network(container, data, options);

        // 添加节点描述
        var descriptions = {
            1: "等待接收客户端 Hello",
            2: "收到客户端 Hello，检查是否需要 Hello Retry Request",
            3: "协商完成，发送服务器 Hello 和其他必要消息",
            4: "等待接收 End of Early Data",
            5: "等待客户端的第二次飞行数据",
            6: "等待接收客户端证书",
            7: "等待接收客户端证书验证",
            8: "等待接收客户端 Finished 消息",
            9: "连接建立完成"
        };

        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                var nodeId = params.nodes[0];
                alert("状态: " + nodes.get(nodeId).label + "\n描述: " + descriptions[nodeId]);
            }
        });
    </script>
</body>

</html>