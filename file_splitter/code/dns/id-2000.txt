//----- (00000001400F5E8C) ----------------------------------------------------
__int64 __fastcall DnsOls_ResetZoneKeymasterFlagForZone(
        __int64 a1,
        __int64 a2,
        int a3,
        int a4,
        LDAP **a5,
        int *a6,
        const wchar_t ***a7,
        ULONG *a8,
        _DWORD *a9)
{
  PWCHAR *v9; // rdx
  LDAP *v10; // r12
  LDAPMessage *v11; // rsi
  unsigned int v12; // edi
  ULONG v13; // r15d
  int v14; // r13d
  __int64 v16; // rax
  LDAP **v17; // r14
  int v18; // eax
  CDnsClientSubnetRecordsTrie *v19; // rcx
  const char *v20; // r9
  __int64 v21; // rdx
  int v22; // r15d
  int *v23; // rax
  int v24; // ecx
  _DWORD *v25; // r14
  const wchar_t **v26; // rsi
  int v27; // eax
  PWCHAR *valuesW; // rax
  ULONG v29; // r14d
  CDnsClientSubnetRecordsTrie *v30; // rcx
  const char *v31; // r8
  const char *v32; // rax
  HANDLE v33; // rcx
  int v34; // esi
  int v35; // eax
  const char *v36; // r9
  __int64 v37; // rcx
  int v38; // eax
  __int64 v39; // rcx
  int v41; // [rsp+40h] [rbp-40h] BYREF
  LDAPMessage *entry; // [rsp+48h] [rbp-38h] BYREF
  PWCHAR *v43; // [rsp+50h] [rbp-30h]
  LDAP *v44; // [rsp+58h] [rbp-28h] BYREF
  unsigned __int16 *v45; // [rsp+60h] [rbp-20h] BYREF
  __int64 v46; // [rsp+68h] [rbp-18h]
  __int128 v47; // [rsp+70h] [rbp-10h] BYREF
  int v48; // [rsp+C8h] [rbp+48h] BYREF
  int v49; // [rsp+D0h] [rbp+50h]
  int v50; // [rsp+D8h] [rbp+58h]

  v50 = a4;
  v49 = a3;
  v9 = 0i64;
  v41 = 1;
  v48 = 0;
  v10 = 0i64;
  v43 = 0i64;
  v11 = 0i64;
  v44 = 0i64;
  v12 = 0;
  entry = 0i64;
  v13 = 0;
  v14 = 0;
  if ( !dword_1401B9740
    || *(_DWORD *)(a1 + 372) != 1
    || (*(_BYTE *)(a1 + 388) & 1) == 0
    || (v16 = *(_QWORD *)(a1 + 840)) == 0 )
  {
    v19 = WPP_GLOBAL_Control;
    v17 = a5;
    goto LABEL_31;
  }
  if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
    && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 5u )
  {
    WPP_SF_sS(
      *((_QWORD *)WPP_GLOBAL_Control + 7),
      0x3Bu,
      (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
      *(const char **)(a1 + 16),
      v16);
    a4 = v50;
  }
  v17 = a5;
  if ( a5 && (v10 = *a5) != 0i64 )
  {
    v44 = *a5;
  }
  else
  {
    v18 = Ds_BindToFsmo((__int64 *)&v44, &v41, a4);
    v12 = v18;
    if ( v18 )
    {
      v19 = WPP_GLOBAL_Control;
      if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
        && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
        && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 2u )
      {
        WPP_SF_D(
          *((_QWORD *)WPP_GLOBAL_Control + 7),
          0x3Cu,
          (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
          v18);
        v19 = WPP_GLOBAL_Control;
      }
      v10 = v44;
      v12 = 9906;
      goto LABEL_30;
    }
    if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
      && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
      && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
    {
      v20 = "domain naming master";
      if ( v41 )
        v20 = "local DC";
      WPP_SF_s(
        *((_QWORD *)WPP_GLOBAL_Control + 7),
        0x3Du,
        (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
        v20);
    }
    v10 = v44;
  }
  if ( !(unsigned int)Zone_LockForWriteEx(a1, 1, 0x2710u, (__int64)"ds\\dns\\server\\server\\olsds.cpp", 248) )
  {
    v25 = a9;
    if ( a9 && *a9 )
    {
      v26 = *a7;
      v43 = (PWCHAR *)*a7;
      v13 = *a8;
LABEL_58:
      v29 = 0;
      if ( v13 )
      {
        while ( _wcsicmp(*(const wchar_t **)(a1 + 840), *v26) )
        {
          ++v29;
          ++v26;
          if ( v29 >= v13 )
            goto LABEL_63;
        }
        v14 = 1;
      }
LABEL_63:
      v30 = WPP_GLOBAL_Control;
      if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
        && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
        && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
      {
        v31 = "not the";
        if ( (*(_BYTE *)(a1 + 1040) & 2) != 0 )
          v31 = "the";
        v32 = "not found";
        if ( v14 )
          v32 = "found";
        WPP_SF_sss(
          *((_QWORD *)WPP_GLOBAL_Control + 7),
          0x40u,
          (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
          *(const char **)(a1 + 16),
          (__int64)v32,
          (__int64)v31);
        v30 = WPP_GLOBAL_Control;
      }
      if ( ((*(_DWORD *)(a1 + 1040) >> 1) & 1) == v14 )
      {
        v34 = v48;
      }
      else
      {
        if ( v30 != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
          && (*((_DWORD *)v30 + 17) & 0x200000) != 0
          && *((_BYTE *)v30 + 65) >= 4u )
        {
          WPP_SF_(*((_QWORD *)v30 + 7), 0x41u, (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids);
        }
        *(_QWORD *)(a1 + 1128) = 0i64;
        v33 = g_hOlsKeyRolloverEvent;
        *(_QWORD *)(a1 + 1116) = 0i64;
        SetEvent(v33);
        v34 = 1;
      }
      v35 = *(_DWORD *)(a1 + 1040) ^ (*(_DWORD *)(a1 + 1040) ^ (2 * v14)) & 2;
      *(_DWORD *)(a1 + 1040) = v35;
      if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
        && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
        && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
      {
        v36 = "FALSE";
        if ( (v35 & 2) != 0 )
          v36 = "TRUE";
        WPP_SF_ss(
          *((_QWORD *)WPP_GLOBAL_Control + 7),
          0x42u,
          (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
          v36,
          *(_QWORD *)(a1 + 16));
      }
      if ( v34 )
      {
        if ( (*(_BYTE *)(a1 + 1040) & 2) != 0 )
        {
          v37 = *(_QWORD *)(a1 + 1080);
          if ( v37 )
          {
            if ( (*(_DWORD *)(a1 + 396) & 0x2000) == 0 )
            {
              v45 = *(unsigned __int16 **)(a1 + 24);
              v46 = v37;
              LOWORD(v48) = 769;
              v47 = DNS_EVENT_DNSSEC_KEYMASTER_ROLE_TRANSFERRED;
              Eventlog_LogEvent((__int64)&v47, v21, 2u, &v45, (unsigned __int8 *)&v48, 0, 0, 0i64);
            }
          }
        }
      }
      v38 = v49;
      v22 = v50;
      if ( v49 )
      {
        v12 = DnsOls_DiscoverZoneKeymasterFqdn(a1, v21, v50, v10);
        if ( v12 )
        {
          if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
            && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
            && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 2u )
          {
            WPP_SF_Ds(
              *((_QWORD *)WPP_GLOBAL_Control + 7),
              0x43u,
              (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
              v12,
              *(_QWORD *)(a1 + 16));
          }
          v12 = 0;
        }
        v38 = v49;
      }
      if ( v34 && (*(_BYTE *)(a1 + 1040) & 2) == 0 )
      {
        if ( !v38 )
        {
          v12 = DnsOls_DiscoverZoneKeymasterFqdn(a1, v21, v22, v10);
          if ( v12 )
          {
            if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
              && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
              && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 2u )
            {
              WPP_SF_Ds(
                *((_QWORD *)WPP_GLOBAL_Control + 7),
                0x44u,
                (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
                v12,
                *(_QWORD *)(a1 + 16));
            }
            v12 = 0;
          }
        }
        v39 = *(_QWORD *)(a1 + 1080);
        if ( v39 )
        {
          v45 = *(unsigned __int16 **)(a1 + 24);
          v46 = v39;
          LOWORD(v48) = 769;
          v47 = DNS_EVENT_DNSSEC_KEYMASTER_CHANGE_DETECTED;
          Eventlog_LogEvent((__int64)&v47, v21, 2u, &v45, (unsigned __int8 *)&v48, 0, 0, 0i64);
        }
      }
      v11 = entry;
      goto LABEL_50;
    }
    v27 = Ds_LoadOrCreateSettingsObject(v10, &entry, 0);
    v12 = v27;
    if ( v27 )
    {
      if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
        && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
        && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 2u )
      {
        WPP_SF_D(
          *((_QWORD *)WPP_GLOBAL_Control + 7),
          0x3Fu,
          (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
          v27);
      }
      v11 = entry;
    }
    else
    {
      v11 = entry;
      if ( entry )
      {
        valuesW = ldap_get_valuesW(v10, entry, (const PWSTR)L"msDNS-KeymasterZones");
        v43 = valuesW;
        v26 = (const wchar_t **)valuesW;
        if ( valuesW )
          v13 = ldap_count_valuesW(valuesW);
        Dbg_KeymasterValuesForLocalServer();
        if ( v25 )
        {
          *a7 = v26;
          *a8 = v13;
          *v25 = 1;
        }
        goto LABEL_58;
      }
      if ( v25 )
        *v25 = 1;
    }
    v22 = v50;
LABEL_50:
    Zone_UnlockAfterWriteEx(a1, 1, (__int64)"ds\\dns\\server\\server\\olsds.cpp", 211);
    v19 = WPP_GLOBAL_Control;
    v9 = v43;
    v17 = a5;
    goto LABEL_32;
  }
  v19 = WPP_GLOBAL_Control;
  if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x200000) != 0
    && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
  {
    WPP_SF_s(
      *((_QWORD *)WPP_GLOBAL_Control + 7),
      0x3Eu,
      (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids,
      *(const char **)(a1 + 16));
    v19 = WPP_GLOBAL_Control;
  }
LABEL_30:
  v9 = 0i64;
LABEL_31:
  v22 = v50;
LABEL_32:
  if ( !a9 && v9 )
  {
    ldap_value_freeW(v9);
    v19 = WPP_GLOBAL_Control;
  }
  if ( v11 )
  {
    ldap_msgfree(v11);
    v19 = WPP_GLOBAL_Control;
  }
  if ( v17 )
  {
    if ( !*v17 )
    {
      v23 = a6;
      v24 = v41;
      *v17 = v10;
      *v23 = v24;
LABEL_113:
      v19 = WPP_GLOBAL_Control;
    }
  }
  else if ( !v41 && !v22 )
  {
    Ds_LdapUnbind(&v44);
    goto LABEL_113;
  }
  if ( v19 != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)v19 + 17) & 0x200000) != 0
    && *((_BYTE *)v19 + 65) >= 4u )
  {
    WPP_SF_D(*((_QWORD *)v19 + 7), 0x45u, (__int64)&WPP_b7aea06a65693a31b0dd129af848d3b8_Traceguids, v12);
  }
  return v12;
}
// 1400F63E5: variable 'v21' is possibly undefined
// 1401861C8: using guessed type __int128 DNS_EVENT_DNSSEC_KEYMASTER_CHANGE_DETECTED;
// 1401868B8: using guessed type __int128 DNS_EVENT_DNSSEC_KEYMASTER_ROLE_TRANSFERRED;
// 1401B9740: using guessed type int dword_1401B9740;
