//----- (0000000140047F24) ----------------------------------------------------
__int64 __fastcall Ds_AddPrincipalAccess(
        LDAP *ExternalHandle,
        PWSTR base,
        void *a3,
        unsigned __int16 *a4,
        unsigned int a5,
        unsigned int a6,
        int a7,
        int a8)
{
  __int64 *v9; // rax
  struct berval **v13; // r14
  _QWORD *v14; // rdi
  ULONG v15; // ebx
  unsigned int v16; // ebx
  LDAPMessage *entry; // rax
  struct berval **values_lenW; // rax
  __int64 v19; // rdx
  __int64 v20; // r8
  ULONG LastError; // eax
  int ServerControls; // [rsp+38h] [rbp-49h]
  int ClientControls; // [rsp+40h] [rbp-41h]
  _QWORD *v25; // [rsp+68h] [rbp-19h] BYREF
  PLDAPMessage res; // [rsp+70h] [rbp-11h] BYREF
  PLDAPControlW v27[2]; // [rsp+78h] [rbp-9h] BYREF
  PWSTR attrs[2]; // [rsp+88h] [rbp+7h] BYREF

  attrs[0] = off_1401B6C40;
  v9 = &SecurityDescriptorControl_D;
  res = 0i64;
  if ( a8 )
    v9 = &SecurityDescriptorControl_DGO;
  attrs[1] = 0i64;
  v27[0] = (PLDAPControlW)v9;
  v25 = 0i64;
  v27[1] = 0i64;
  v13 = 0i64;
  v14 = 0i64;
  if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
    && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
  {
    WPP_SF_S(
      *((_QWORD *)WPP_GLOBAL_Control + 7),
      0x1C8u,
      (__int64)&WPP_d0fa00cabf37307abd3d7f77fcc28067_Traceguids,
      base);
  }
  v15 = ldap_search_ext_sW(ExternalHandle, base, 0, g_szWildCardFilter, attrs, 0, v27, 0i64, &g_LdapTimeout, 0, &res);
  if ( v15 )
  {
    if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
      && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
      && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
    {
      WPP_SF_DS(
        *((_QWORD *)WPP_GLOBAL_Control + 7),
        0x1C9u,
        (__int64)&WPP_d0fa00cabf37307abd3d7f77fcc28067_Traceguids,
        v15,
        (__int64)base);
    }
    v16 = Ds_ErrorHandler(v15, (__int64)base, ExternalHandle, 0);
  }
  else
  {
    entry = ldap_first_entry(ExternalHandle, res);
    values_lenW = ldap_get_values_lenW(ExternalHandle, entry, off_1401B6C40);
    v13 = values_lenW;
    if ( values_lenW && *values_lenW )
    {
      v16 = SD_AddPrincipalToSD(a3, a4, (*values_lenW)->bv_val, &v25, a5, a6, ServerControls, ClientControls, a7, a8);
      if ( v16 )
      {
        if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
          && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
          && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
        {
          WPP_SF_SqS(*((_QWORD *)WPP_GLOBAL_Control + 7), v19, v20, a4, (char)a3, (__int64)base);
        }
        v14 = v25;
      }
      else
      {
        if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
          && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
          && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
        {
          WPP_SF_SS(
            *((_QWORD *)WPP_GLOBAL_Control + 7),
            0x1CCu,
            (__int64)&WPP_d0fa00cabf37307abd3d7f77fcc28067_Traceguids,
            off_1401B6C40,
            (__int64)base);
        }
        v14 = v25;
        v16 = Ds_WriteDnSecurity(ExternalHandle, base, (__int64)v25, a8);
        if ( v16
          && WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
          && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
          && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
        {
          WPP_SF_S(
            *((_QWORD *)WPP_GLOBAL_Control + 7),
            0x1CDu,
            (__int64)&WPP_d0fa00cabf37307abd3d7f77fcc28067_Traceguids,
            base);
        }
      }
    }
    else
    {
      if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
        && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
        && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
      {
        WPP_SF_(*((_QWORD *)WPP_GLOBAL_Control + 7), 0x1CAu, (__int64)&WPP_d0fa00cabf37307abd3d7f77fcc28067_Traceguids);
      }
      LastError = LdapGetLastError();
      v16 = 16;
      if ( LastError )
        v16 = LastError;
    }
  }
  if ( res )
    ldap_msgfree(res);
  if ( v13 )
    ldap_value_free_len(v13);
  if ( v14 )
    Mem_Free(v14, 0i64, 0i64, (__int64)"ds\\dns\\server\\server\\ds.c", 17606);
  return v16;
}
// 1400480D0: variable 'ServerControls' is possibly undefined
// 1400480D0: variable 'ClientControls' is possibly undefined
// 14004810E: variable 'v19' is possibly undefined
// 14004810E: variable 'v20' is possibly undefined
// 1401EC3A0: using guessed type __int64 SecurityDescriptorControl_D;
// 1401EC440: using guessed type __int64 SecurityDescriptorControl_DGO;
