//----- (00000001400B02F8) ----------------------------------------------------
__int64 __fastcall checkPartitionForTombstones(__int64 a1)
{
  __int64 v1; // rsi
  int v2; // r14d
  unsigned int NextMessageInSearch; // edi
  unsigned int v4; // r15d
  CDnsClientSubnetRecordsTrie *v5; // rcx
  const char *v6; // rdx
  const char *v7; // r13
  const char *v8; // r9
  WCHAR *v9; // rdx
  PLDAPSearch inited; // rax
  int LastError; // eax
  ULONG v12; // eax
  int v13; // ebx
  PWCHAR dnW; // rax
  unsigned __int16 *v15; // rbx
  CDnsClientSubnetRecordsTrie *v16; // rcx
  const unsigned __int16 *v17; // r9
  __int64 *values_lenW; // rax
  struct berval **v19; // rdi
  PCHAR bv_val; // rax
  unsigned __int16 v21; // dx
  int v22; // eax
  __int64 v23; // r8
  CDnsClientSubnetRecordsTrie *v24; // r10
  int v25; // eax
  const char *v26; // r8
  PZPWSTR AttributeList; // [rsp+28h] [rbp-E0h]
  PWSTR v29[2]; // [rsp+68h] [rbp-A0h] BYREF
  PLDAPControlW ServerControls[2]; // [rsp+78h] [rbp-90h] BYREF
  __int64 v31; // [rsp+88h] [rbp-80h]
  __int64 v32[2]; // [rsp+98h] [rbp-70h] BYREF
  LDAPMessage *entry; // [rsp+A8h] [rbp-60h]
  int v34; // [rsp+D4h] [rbp-34h]

  v1 = a1;
  v31 = a1;
  v2 = 0;
  NextMessageInSearch = 0;
  memset_0(v32, 0, 0x190ui64);
  v4 = 0;
  v5 = WPP_GLOBAL_Control;
  if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
    && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 5u )
  {
    WPP_SF_Dq(
      *((_QWORD *)WPP_GLOBAL_Control + 7),
      0xCu,
      (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
      dword_1401B9714);
    v5 = WPP_GLOBAL_Control;
  }
  if ( v1 )
  {
    if ( (qword_1401B9780 & 0x20000) != 0 )
    {
      if ( (unsigned int)Log_EnterLock() )
      {
        v6 = *(const char **)(v1 + 24);
        g_pszCurrentLogLevelString = (__int64)"TOMBSTN";
        Log_Printf("Checking directory partition %s for expired tombstones\n", v6);
LABEL_12:
        g_pszCurrentLogLevelString = 0i64;
        Log_LeaveLock();
        goto LABEL_13;
      }
      goto LABEL_13;
    }
  }
  else if ( (qword_1401B9780 & 0x20000) != 0 )
  {
    if ( (unsigned int)Log_EnterLock() )
    {
      g_pszCurrentLogLevelString = (__int64)"TOMBSTN";
      Log_Printf("Checking the legacy partition for expired tombstones\n");
      goto LABEL_12;
    }
LABEL_13:
    v5 = WPP_GLOBAL_Control;
  }
  v7 = "Legacy";
  if ( v5 != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)v5 + 17) & 0x400) != 0
    && *((_BYTE *)v5 + 65) >= 5u )
  {
    if ( v1 )
      v8 = *(const char **)(v1 + 24);
    else
      v8 = "Legacy";
    WPP_SF_s(*((_QWORD *)v5 + 7), 0xDu, (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids, v8);
  }
  ServerControls[1] = 0i64;
  ServerControls[0] = (PLDAPControlW)&NoDsSvrReferralControl;
  v29[0] = off_1401B6C28;
  v29[1] = 0i64;
  memset_0(v32, 0, 0x190ui64);
  v34 = 1;
  if ( v1 )
    v9 = *(WCHAR **)(v1 + 40);
  else
    v9 = DistinguishedName;
  inited = ldap_search_init_pageW(pServerLdap, v9, 2u, SearchFilter, v29, 0, ServerControls, 0i64, 0, 0, 0i64);
  if ( inited )
  {
    v32[0] = (__int64)inited;
    v13 = 0;
  }
  else
  {
    if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
      && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
      && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
    {
      LastError = LdapGetLastError();
      WPP_SF_D(
        *((_QWORD *)WPP_GLOBAL_Control + 7),
        0xAu,
        (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
        LastError);
    }
    v12 = LdapGetLastError();
    v13 = Ds_ErrorHandler(v12, 0i64, pServerLdap, 0);
    if ( !v13 )
      v13 = 1168899;
    if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
      && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
      && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
    {
      WPP_SF_D(
        *((_QWORD *)WPP_GLOBAL_Control + 7),
        0xBu,
        (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
        v13);
    }
  }
  if ( !v13 )
  {
    v29[0] = 0i64;
    NextMessageInSearch = Ds_GetNextMessageInSearch((__int64)v32);
    if ( !NextMessageInSearch )
    {
      while ( 1 )
      {
        dnW = ldap_get_dnW(pServerLdap, entry);
        v15 = dnW;
        v16 = WPP_GLOBAL_Control;
        if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
          && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
          && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
        {
          v17 = L"NULL-DN";
          if ( dnW )
            v17 = dnW;
          WPP_SF_S(
            *((_QWORD *)WPP_GLOBAL_Control + 7),
            0xEu,
            (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
            v17);
          v16 = WPP_GLOBAL_Control;
        }
        if ( v15 && *v15 )
        {
          values_lenW = (__int64 *)ldap_get_values_lenW(pServerLdap, entry, off_1401B6C28);
          v19 = (struct berval **)values_lenW;
          if ( !values_lenW || (unsigned int)Ds_ValidateDsRecord((__int64)v15, *values_lenW) )
          {
            if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
              && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
              && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
            {
              WPP_SF_S(
                *((_QWORD *)WPP_GLOBAL_Control + 7),
                0x11u,
                (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
                v15);
            }
            v22 = ldap_delete_sW(pServerLdap, v15);
            if ( v22 )
            {
              if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
                && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
                && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
              {
                WPP_SF_DS(
                  *((_QWORD *)WPP_GLOBAL_Control + 7),
                  0x12u,
                  (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
                  v22,
                  (__int64)v15);
              }
            }
            else
            {
              ++v4;
            }
          }
          else
          {
            bv_val = (*v19)->bv_val;
            v21 = *((_WORD *)bv_val + 1);
            if ( v21 )
            {
              if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
                && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
                && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
              {
                WPP_SF_D(
                  *((_QWORD *)WPP_GLOBAL_Control + 7),
                  0x10u,
                  (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
                  v21);
              }
            }
            else
            {
              v2 = 1;
              v29[0] = *((PWSTR *)bv_val + 3);
            }
          }
          ldap_value_free_len(v19);
          if ( v2 )
          {
            GetSystemTimeAsFileTime((LPFILETIME)ServerControls);
            v24 = WPP_GLOBAL_Control;
            if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
              && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
              && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
            {
              LODWORD(AttributeList) = dword_1401B985C;
              WPP_SF_ILS(
                *((_QWORD *)WPP_GLOBAL_Control + 7),
                ((char *)ServerControls[0] - (char *)v29[0]) / 0x989680ui64,
                v23,
                ((char *)ServerControls[0] - (char *)v29[0]) / 0x989680ui64,
                AttributeList,
                v15);
              v24 = WPP_GLOBAL_Control;
            }
            if ( (char *)ServerControls[0] - (char *)v29[0] > 10000000 * (unsigned __int64)(unsigned int)dword_1401B985C )
            {
              if ( v24 != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
                && (*((_DWORD *)v24 + 17) & 0x400) != 0
                && *((_BYTE *)v24 + 65) >= 4u )
              {
                WPP_SF_S(*((_QWORD *)v24 + 7), 0x14u, (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids, v15);
              }
              v25 = ldap_delete_sW(pServerLdap, v15);
              if ( v25 )
              {
                if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
                  && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
                  && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 4u )
                {
                  WPP_SF_DS(
                    *((_QWORD *)WPP_GLOBAL_Control + 7),
                    0x15u,
                    (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
                    v25,
                    (__int64)v15);
                }
              }
              else
              {
                ++v4;
              }
            }
          }
        }
        else
        {
          if ( v16 != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
            && (*((_DWORD *)v16 + 17) & 0x400) != 0
            && *((_BYTE *)v16 + 65) >= 4u )
          {
            WPP_SF_(*((_QWORD *)v16 + 7), 0xFu, (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids);
          }
          if ( !v15 )
            goto LABEL_86;
        }
        ldap_memfreeW(v15);
LABEL_86:
        v29[0] = 0i64;
        v2 = 0;
        NextMessageInSearch = Ds_GetNextMessageInSearch((__int64)v32);
        if ( NextMessageInSearch )
        {
          v1 = v31;
          v7 = "Legacy";
          break;
        }
      }
    }
  }
  Ds_CleanupSearchBlob((__int64)v32);
  if ( v1 )
  {
    if ( (qword_1401B9780 & 0x20000) != 0 && (unsigned int)Log_EnterLock() )
    {
      v26 = *(const char **)(v1 + 24);
      g_pszCurrentLogLevelString = (__int64)"TOMBSTN";
      Log_Printf("Deleted %d expired tombstones from directory partition %s\n", v4, v26);
LABEL_95:
      g_pszCurrentLogLevelString = 0i64;
      Log_LeaveLock();
    }
  }
  else if ( (qword_1401B9780 & 0x20000) != 0 && (unsigned int)Log_EnterLock() )
  {
    g_pszCurrentLogLevelString = (__int64)"TOMBSTN";
    Log_Printf("Deleted %d expired tombstones from the legacy partition\n", v4);
    goto LABEL_95;
  }
  if ( WPP_GLOBAL_Control != (CDnsClientSubnetRecordsTrie *)&WPP_GLOBAL_Control
    && (*((_DWORD *)WPP_GLOBAL_Control + 17) & 0x400) != 0
    && *((_BYTE *)WPP_GLOBAL_Control + 65) >= 5u )
  {
    if ( v1 )
      v7 = *(const char **)(v1 + 24);
    WPP_SF_Ds(
      *((_QWORD *)WPP_GLOBAL_Control + 7),
      0x16u,
      (__int64)&WPP_17581ef235eb3dfa38ea8181ec00f36d_Traceguids,
      v4,
      (__int64)v7);
  }
  return NextMessageInSearch;
}
// 1400B07C2: variable 'v23' is possibly undefined
// 1400B07C2: variable 'AttributeList' is possibly undefined
// 140191530: using guessed type wchar_t aNullDn[8];
// 1401B8F28: using guessed type __int64 g_pszCurrentLogLevelString;
// 1401B9714: using guessed type int dword_1401B9714;
// 1401B9780: using guessed type __int64 qword_1401B9780;
// 1401B985C: using guessed type int dword_1401B985C;
// 1401EC420: using guessed type __int64 NoDsSvrReferralControl;
